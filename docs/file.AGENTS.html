<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: AGENTS
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "AGENTS";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: AGENTS</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="agentsmd---prism-merge-development-guide">AGENTS.md - prism-merge Development Guide</h1>

<h2 id="-project-overview">ğŸ¯ Project Overview</h2>

<p><code>prism-merge</code> is a <strong>format-specific implementation of the <code>*-merge</code> gem family</strong> for Ruby files. It provides intelligent Ruby file merging using AST analysis via the Prism parser.</p>

<p><strong>Core Philosophy</strong>: Intelligent Ruby code merging that preserves structure, comments, and formatting while applying updates from templates.</p>

<p><strong>Repository</strong>: https://github.com/kettle-rb/prism-merge<br>
<strong>Current Version</strong>: 2.0.0<br>
<strong>Required Ruby</strong>: &gt;= 3.2.0 (currently developed against Ruby 4.0.1)</p>

<h2 id="ï¸-ai-agent-terminal-limitations">âš ï¸ AI Agent Terminal Limitations</h2>

<h3 id="terminal-output-is-not-visible">Terminal Output Is Not Visible</h3>

<p><strong>CRITICAL</strong>: AI agents using <code>run_in_terminal</code> almost never see the command output. The terminal tool sends commands to a persistent Copilot terminal, but output is frequently lost or invisible to the agent.</p>

<p><strong>Workaround</strong>: Always redirect output to a file in the projectâ€™s local <code>tmp/</code> directory, then read it back with <code>read_file</code>:</p>

<pre class="code language-bash"><code class="language-bash">bundle exec rspec spec/some_spec.rb &gt; tmp/test_output.txt 2&gt;&amp;1
</code></pre>

<p><strong>NEVER</strong> use <code>/tmp</code> or other system directories â€” always use the projectâ€™s own <code>tmp/</code> directory.</p>

<h3 id="direnv-requires-separate-cd-command">direnv Requires Separate <code>cd</code> Command</h3>

<p><strong>CRITICAL</strong>: Never chain <code>cd</code> with other commands via <code>&amp;&amp;</code>. The <code>direnv</code> environment wonâ€™t initialize until after all chained commands finish. Run <code>cd</code> alone first:</p>

<p>âœ… <strong>CORRECT</strong>:</p>
<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/prism-merge
</code></pre>
<pre class="code language-bash"><code class="language-bash">bundle exec rspec &gt; tmp/test_output.txt 2&gt;&amp;1
</code></pre>

<p>âŒ <strong>WRONG</strong>:</p>
<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/prism-merge &amp;&amp; bundle exec rspec
</code></pre>

<h3 id="prefer-internal-tools-over-terminal">Prefer Internal Tools Over Terminal</h3>

<p>Use <code>read_file</code>, <code>list_dir</code>, <code>grep_search</code>, <code>file_search</code> instead of terminal commands for gathering information. Only use terminal for running tests, installing dependencies, and git operations.</p>

<h3 id="grep_search-cannot-search-nested-git-projects">grep_search Cannot Search Nested Git Projects</h3>

<p>This project is a nested git project inside the <code>ast-merge</code> workspace. The <code>grep_search</code> tool <strong>cannot</strong> search inside it. Use <code>read_file</code> and <code>list_dir</code> instead.</p>

<h3 id="never-pipe-test-commands-through-headtail">NEVER Pipe Test Commands Through head/tail</h3>

<p>Always redirect to a file in <code>tmp/</code> instead of truncating output.</p>

<h2 id="ï¸-architecture-format-specific-implementation">ğŸ—ï¸ Architecture: Format-Specific Implementation</h2>

<h3 id="what-prism-merge-provides">What prism-merge Provides</h3>

<ul>
  <li>
<strong><code>Prism::Merge::SmartMerger</code></strong> â€“ Ruby-specific SmartMerger implementation</li>
  <li>
<strong><code>Prism::Merge::FileAnalysis</code></strong> â€“ Ruby file analysis with statement extraction</li>
  <li>
<strong><code>Prism::Merge::NodeWrapper</code></strong> â€“ Wrapper for Prism AST nodes</li>
  <li>
<strong><code>Prism::Merge::MergeResult</code></strong> â€“ Ruby-specific merge result</li>
  <li>
<strong><code>Prism::Merge::ConflictResolver</code></strong> â€“ Ruby conflict resolution</li>
  <li>
<strong><code>Prism::Merge::FreezeNode</code></strong> â€“ Ruby freeze block support</li>
  <li>
<strong><code>Prism::Merge::Comment::*</code></strong> â€“ Ruby comment classes with magic comment detection</li>
  <li>
<strong><code>Prism::Merge::DebugLogger</code></strong> â€“ Prism-specific debug logging</li>
</ul>

<h3 id="key-dependencies">Key Dependencies</h3>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Role</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
<code>ast-merge</code> (~&gt; 4.0)</td>
      <td>Base classes and shared infrastructure</td>
    </tr>
    <tr>
      <td>
<code>tree_haver</code> (~&gt; 5.0)</td>
      <td>Unified parser adapter (wraps Prism)</td>
    </tr>
    <tr>
      <td>
<code>prism</code> (~&gt; 1.6)</td>
      <td>Ruby parser</td>
    </tr>
    <tr>
      <td>
<code>version_gem</code> (~&gt; 1.1)</td>
      <td>Version management</td>
    </tr>
  </tbody>
</table>

<h3 id="parser-backend">Parser Backend</h3>

<p>prism-merge uses the Prism parser exclusively via TreeHaverâ€™s <code>:prism_backend</code>:</p>

<table>
  <thead>
    <tr>
      <th>Backend</th>
      <th>Parser</th>
      <th>Platform</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>:prism_backend</code></td>
      <td>Prism</td>
      <td>All Ruby platforms</td>
      <td>Fast, error-tolerant Ruby parser</td>
    </tr>
  </tbody>
</table>

<h2 id="-project-structure">ğŸ“ Project Structure</h2>

<pre class="code ruby"><code class="ruby">lib/prism/merge/
â”œâ”€â”€ smart_merger.rb          # Main SmartMerger implementation
â”œâ”€â”€ file_analysis.rb         # Ruby file analysis
â”œâ”€â”€ node_wrapper.rb          # AST node wrapper for Prism nodes
â”œâ”€â”€ merge_result.rb          # Merge result object
â”œâ”€â”€ conflict_resolver.rb     # Conflict resolution
â”œâ”€â”€ freeze_node.rb           # Freeze block support
â”œâ”€â”€ comment/                 # Ruby-specific comment handling
â”‚   â”œâ”€â”€ magic.rb            # Magic comment detection
â”‚   â””â”€â”€ parser.rb           # Comment parser
â”œâ”€â”€ debug_logger.rb          # Debug logging
â””â”€â”€ version.rb

spec/prism/merge/
â”œâ”€â”€ smart_merger_spec.rb
â”œâ”€â”€ file_analysis_spec.rb
â”œâ”€â”€ node_wrapper_spec.rb
â””â”€â”€ integration/
</code></pre>

<h2 id="-development-workflows">ğŸ”§ Development Workflows</h2>

<h3 id="running-tests">Running Tests</h3>

<pre class="code language-bash"><code class="language-bash"># Full suite (required for coverage thresholds)
bundle exec rspec

# Single file (disable coverage threshold check)
K_SOUP_COV_MIN_HARD=false bundle exec rspec spec/prism/merge/smart_merger_spec.rb
</code></pre>

<p><strong>Note</strong>: Always run commands in the project root (<code>/home/pboling/src/kettle-rb/ast-merge/vendor/prism-merge</code>). Allow <code>direnv</code> to load environment variables first by doing a plain <code>cd</code> before running commands.</p>

<h3 id="coverage-reports">Coverage Reports</h3>

<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/prism-merge
bin/rake coverage &amp;&amp; bin/kettle-soup-cover -d
</code></pre>

<p><strong>Key ENV variables</strong> (set in <code>.envrc</code>, loaded via <code>direnv allow</code>):</p>
<ul>
  <li>
<code>K_SOUP_COV_DO=true</code> â€“ Enable coverage</li>
  <li>
<code>K_SOUP_COV_MIN_LINE=100</code> â€“ Line coverage threshold</li>
  <li>
<code>K_SOUP_COV_MIN_BRANCH=82</code> â€“ Branch coverage threshold</li>
  <li>
<code>K_SOUP_COV_MIN_HARD=true</code> â€“ Fail if thresholds not met</li>
</ul>

<h3 id="code-quality">Code Quality</h3>

<pre class="code language-bash"><code class="language-bash">bundle exec rake reek
bundle exec rake rubocop_gradual
</code></pre>

<h2 id="-project-conventions">ğŸ“ Project Conventions</h2>

<h3 id="api-conventions">API Conventions</h3>

<h4 id="smartmerger-api">SmartMerger API</h4>
<ul>
  <li>
<code>merge</code> â€“ Returns a <strong>String</strong> (the merged Ruby content)</li>
  <li>
<code>merge_result</code> â€“ Returns a <strong>MergeResult</strong> object</li>
  <li>
<code>to_s</code> on MergeResult returns the merged content as a string</li>
</ul>

<h4 id="ruby-specific-features">Ruby-Specific Features</h4>

<p><strong>Statement-Level Merging</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby">merger = Prism::Merge::SmartMerger.new(template_rb, dest_rb)
result = merger.merge
</code></pre>

<p><strong>Freeze Blocks</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby"># prism-merge:freeze
CUSTOM_CONSTANT = &quot;don&#39;t override&quot;
# prism-merge:unfreeze

class MyClass
end
</code></pre>

<p><strong>Magic Comment Preservation</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby"># frozen_string_literal: true
# encoding: utf-8
# warn_indent: true

# Magic comments are preserved and properly positioned
</code></pre>

<p><strong>Section-Based Merging</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby">class MyClass
  # Template sections
  def template_method
  end
  
  # Destination customizations
  def custom_method
  end
end
</code></pre>

<h3 id="kettle-dev-tooling">kettle-dev Tooling</h3>

<p>This project uses <code>kettle-dev</code> for gem maintenance automation:</p>

<ul>
  <li>
<strong>Rakefile</strong>: Sourced from kettle-dev template</li>
  <li>
<strong>CI Workflows</strong>: GitHub Actions and GitLab CI managed via kettle-dev</li>
  <li>
<strong>Releases</strong>: Use <code>kettle-release</code> for automated release process</li>
</ul>

<h3 id="version-requirements">Version Requirements</h3>
<ul>
  <li>Ruby &gt;= 3.2.0 (gemspec), developed against Ruby 4.0.1 (<code>.tool-versions</code>)</li>
  <li>
<code>ast-merge</code> &gt;= 4.0.0 required</li>
  <li>
<code>tree_haver</code> &gt;= 5.0.3 required</li>
  <li>
<code>prism</code> &gt;= 1.6.0 required</li>
</ul>

<h2 id="-testing-patterns">ğŸ§ª Testing Patterns</h2>

<h3 id="treehaver-dependency-tags">TreeHaver Dependency Tags</h3>

<p>All spec files use TreeHaver RSpec dependency tags for conditional execution:</p>

<p><strong>Available tags</strong>:</p>
<ul>
  <li>
<code>:prism_backend</code> â€“ Requires Prism backend</li>
  <li>
<code>:ruby_parsing</code> â€“ Requires Ruby parser</li>
</ul>

<p>âœ… <strong>CORRECT</strong> â€“ Use dependency tag on describe/context/it:</p>
<pre class="code language-ruby"><code class="language-ruby">RSpec.describe Prism::Merge::SmartMerger, :prism_backend do
  # Skipped if Prism not available
end

it &quot;parses Ruby&quot;, :ruby_parsing do
  # Skipped if no Ruby parser available
end
</code></pre>

<p>âŒ <strong>WRONG</strong> â€“ Never use manual skip checks:</p>
<pre class="code language-ruby"><code class="language-ruby">before do
  skip &quot;Requires Prism&quot; unless defined?(Prism)  # DO NOT DO THIS
end
</code></pre>

<h3 id="shared-examples">Shared Examples</h3>

<p>prism-merge uses shared examples from <code>ast-merge</code>:</p>

<pre class="code language-ruby"><code class="language-ruby">it_behaves_like &quot;Ast::Merge::FileAnalyzable&quot;
it_behaves_like &quot;Ast::Merge::ConflictResolverBase&quot;
it_behaves_like &quot;a reproducible merge&quot;, &quot;scenario_name&quot;, { preference: :template }
</code></pre>

<h2 id="-critical-files">ğŸ” Critical Files</h2>

<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>lib/prism/merge/smart_merger.rb</code></td>
      <td>Main Ruby SmartMerger implementation</td>
    </tr>
    <tr>
      <td><code>lib/prism/merge/file_analysis.rb</code></td>
      <td>Ruby file analysis and statement extraction</td>
    </tr>
    <tr>
      <td><code>lib/prism/merge/node_wrapper.rb</code></td>
      <td>Prism node wrapper with Ruby-specific methods</td>
    </tr>
    <tr>
      <td><code>lib/prism/merge/comment/magic.rb</code></td>
      <td>Magic comment detection and handling</td>
    </tr>
    <tr>
      <td><code>lib/prism/merge/debug_logger.rb</code></td>
      <td>Prism-specific debug logging</td>
    </tr>
    <tr>
      <td><code>spec/spec_helper.rb</code></td>
      <td>Test suite entry point</td>
    </tr>
    <tr>
      <td><code>.envrc</code></td>
      <td>Coverage thresholds and environment configuration</td>
    </tr>
  </tbody>
</table>

<h2 id="-common-tasks">ğŸš€ Common Tasks</h2>

<pre class="code language-bash"><code class="language-bash"># Run all specs with coverage
bundle exec rake spec

# Generate coverage report
bundle exec rake coverage

# Check code quality
bundle exec rake reek
bundle exec rake rubocop_gradual

# Prepare and release
kettle-changelog &amp;&amp; kettle-release
</code></pre>

<h2 id="-integration-points">ğŸŒŠ Integration Points</h2>

<ul>
  <li>
<strong><code>ast-merge</code></strong>: Inherits base classes (<code>SmartMergerBase</code>, <code>FileAnalyzable</code>, etc.)</li>
  <li>
<strong><code>tree_haver</code></strong>: Wraps Prism parser in unified TreeHaver interface</li>
  <li>
<strong><code>prism</code></strong>: Fast, error-tolerant Ruby parser</li>
  <li>
<strong>RSpec</strong>: Full integration via <code>ast/merge/rspec</code> and <code>tree_haver/rspec</code>
</li>
  <li>
<strong>SimpleCov</strong>: Coverage tracked for <code>lib/**/*.rb</code>; spec directory excluded</li>
</ul>

<h2 id="-key-insights">ğŸ’¡ Key Insights</h2>

<ol>
  <li>
<strong>Section-based merging</strong>: Ruby files are merged by top-level statements (classes, methods, constants)</li>
  <li>
<strong>Magic comment handling</strong>: Ruby magic comments are detected and positioned correctly in output</li>
  <li>
<strong>Comment preservation</strong>: Prism provides rich comment information; we preserve all comments</li>
  <li>
<strong>Error tolerance</strong>: Prism can parse Ruby with syntax errors; we detect and report them</li>
  <li>
<strong>Freeze blocks use <code># prism-merge:freeze</code></strong>: Language-specific comment syntax</li>
  <li>
<strong>Signature matching</strong>: Methods matched by name, classes by name, gems by name in Gemfile</li>
  <li>
<strong>No FileAligner/ConflictResolver vestigial</strong>: prism-merge was refactored to remove these unused components</li>
</ol>

<h2 id="-common-pitfalls">ğŸš« Common Pitfalls</h2>

<ol>
  <li>
<strong>NEVER assume valid Ruby</strong>: Use <code>FileAnalysis#valid?</code> to check parse success</li>
  <li>
<strong>NEVER use manual skip checks</strong> â€“ Use dependency tags (<code>:prism_backend</code>, <code>:ruby_parsing</code>)</li>
  <li>
<strong>Magic comments are Ruby-specific</strong> â€“ They belong in prism-merge, not ast-merge</li>
  <li>
<strong>Do NOT load vendor gems</strong> â€“ They are not part of this project; they do not exist in CI</li>
  <li>
<strong>Use <code>tmp/</code> for temporary files</strong> â€“ Never use <code>/tmp</code> or other system directories</li>
  <li>
<strong>Do NOT chain <code>cd</code> with <code>&amp;&amp;</code></strong> â€“ Run <code>cd</code> as a separate command so <code>direnv</code> loads ENV</li>
</ol>

<h2 id="-ruby-specific-notes">ğŸ”§ Ruby-Specific Notes</h2>

<h3 id="node-types-in-prism">Node Types in Prism</h3>
<pre class="code language-ruby"><code class="language-ruby">Prism::CallNode           # Method calls (gem &quot;example&quot;)
Prism::ClassNode          # Class definitions
Prism::ModuleNode         # Module definitions
Prism::DefNode            # Method definitions
Prism::ConstantWriteNode  # CONSTANT = value
Prism::BlockNode          # Blocks { }
</code></pre>

<h3 id="merge-behavior">Merge Behavior</h3>
<ul>
  <li>
<strong>Classes</strong>: Matched by class name; bodies merged recursively</li>
  <li>
<strong>Methods</strong>: Matched by method name; entire method replaced (no body merge)</li>
  <li>
<strong>Gem calls</strong>: Matched by gem name in Gemfile/gemspec</li>
  <li>
<strong>Constants</strong>: Matched by constant name</li>
  <li>
<strong>Comments</strong>: Preserved when attached to statements</li>
  <li>
<strong>Freeze blocks</strong>: Protect customizations from template updates</li>
  <li>
<strong>Magic comments</strong>: Always placed at top of file in correct order</li>
</ul>

<h3 id="magic-comments">Magic Comments</h3>
<pre class="code language-ruby"><code class="language-ruby"># Frozen string literal (should be first)
# frozen_string_literal: true

# Encoding (should be second)
# encoding: utf-8

# Warnings
# warn_indent: true
# warn_past_scope: true

# Shareable constant value
# shareable_constant_value: literal
</code></pre>

<h3 id="section-based-merging-example">Section-Based Merging Example</h3>
<pre class="code language-ruby"><code class="language-ruby"># Template:
class MyClass
  def template_method
    &quot;from template&quot;
  end
end

# Destination:
class MyClass
  def custom_method
    &quot;custom&quot;
  end
end

# Result (preference: :destination):
class MyClass
  def custom_method  # Destination kept
    &quot;custom&quot;
  end
  
  def template_method  # Template added
    &quot;from template&quot;
  end
end
</code></pre>
</div></div>

      <div id="footer">
  Generated on Sun Feb 22 08:01:27 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.1).
</div>

    </div>
  </body>
</html>